name: Auto Deploy on Branch Push

on:
  push:
    branches:
      - main      # Deploy production
      - staging   # Deploy staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        HOST=${{ secrets.SERVER_HOST }}
        PORT=${{ secrets.SERVER_PORT }}
        ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')

        if [ "$BRANCH" = "main" ]; then
          echo "🚀 Deploying to production..."
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd /opt/odoo/hibarr-crm/odoo-production/
            git pull origin main
            sudo systemctl restart odoo-production.service
          EOF
        elif [ "$BRANCH" = "staging" ]; then
          echo "🚀 Deploying to staging..."
          ssh -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd /opt/odoo/hibarr-crm/odoo-staging/
            git pull origin staging
            sudo systemctl restart odoo-staging.service
          EOF
        else
          echo "⚠️ No deployment configured for branch: $BRANCH"
        fi
