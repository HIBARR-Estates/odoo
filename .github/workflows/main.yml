name: Auto Deploy on Branch Push

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        run: |
          BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')
          echo "Current branch is $BRANCH"
          
          if [ "$BRANCH" = "main" ]; then
            echo "üöÄ Deploying to production..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
              cd /opt/odoo/hibarr-crm/odoo-production/
              GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}' git fetch origin
              GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}' git reset --hard origin/main
              sudo systemctl restart odoo-production.service
            "
          elif [ "$BRANCH" = "staging" ]; then
            echo "üöÄ Deploying to staging..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
              cd /opt/odoo/hibarr-crm/odoo-staging/
              GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}' git fetch origin
              GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}' git reset --hard origin/staging
              sudo systemctl restart odoo-staging.service
            "
          else
            echo "‚ö†Ô∏è No deployment configured for branch: $BRANCH"
          fi
