name: Auto Deploy on Branch Push

on:
  push:
    branches:
      - main         # Trigger on pushes to the main branch (prod)
      - staging      # Trigger on pushes to the staging branch (staging)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        HOST=${{ secrets.SERVER_HOST }}
        PORT=${{ secrets.SERVER_PORT }}
        ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts
        echo "SSH key and known_hosts set up."

    - name: Deploy via SSH
      run: |
          BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')
          echo "Current branch is $BRANCH"
          
          if [ "$BRANCH" = "main" ]; then
            echo "üöÄ Deploying to production..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
              cd /opt/odoo/hibarr-crm/odoo-production/
              # 1. Clean up any Python cache files
              sudo -u odoo find . -name '*.pyc' -delete
              
              # 2. Reset to latest GitHub version
              sudo -u odoo git fetch origin
              sudo -u odoo git reset --hard origin/main
              
              # 3. Only then restart the service
              sudo systemctl restart odoo-production.service
              
              echo '‚úÖ Deployment complete!'
            "
          elif [ "$BRANCH" = "staging" ]; then
            echo "üöÄ Deploying to staging..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
              cd /opt/odoo/hibarr-crm/odoo-production/
              # 1. Clean up any Python cache files
              sudo -u odoo find . -name '*.pyc' -delete
              
              # 2. Reset to latest GitHub version
              sudo -u odoo git fetch origin
              sudo -u odoo git reset --hard origin/staging
              
              # 3. Only then restart the service
              sudo systemctl restart odoo-staging.service
              
              echo '‚úÖ Deployment complete!'
            "
          else
            echo "‚ö†Ô∏è No deployment configured for branch: $BRANCH"
          fi
