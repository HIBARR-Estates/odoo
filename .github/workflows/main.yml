name: Auto Deploy on Branch Push

on:
  push:
    branches:
      - main         # Trigger on pushes to the main branch (prod)
      - staging      # Trigger on pushes to the staging branch (staging)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "SSH key and known_hosts set up."

      - name: Set up SSH Agent and Test Git Connection
        run: |
          # Start SSH agent
          eval $(ssh-agent -s)
          
          # Add SSH key to the agent
          ssh-add ~/.ssh/id_rsa
          
          # Test SSH connection (optional)
          ssh -T ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
            echo "SSH connection successful"
          EOF

      - name: Deploy via SSH
        run: |
          BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')
          
          echo "Current branch is $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            echo "🚀 Deploying to production..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
              cd /opt/odoo/hibarr-crm/odoo-production/
              # Use the full path to git command and ensure SSH agent is used
              GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}" git fetch origin
              GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}" git reset --hard origin/main
              sudo systemctl restart odoo-production.service
            EOF

          elif [ "$BRANCH" = "staging" ]; then
            echo "🚀 Deploying to staging..."
            ssh -v -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
              cd /opt/odoo/hibarr-crm/odoo-staging/
              # Use the full path to git command and ensure SSH agent is used
              GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}" git fetch origin
              GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -p ${{ secrets.SERVER_PORT }}" git reset --hard origin/staging
              sudo systemctl restart odoo-staging.service
            EOF

          else
            echo "⚠️ No deployment configured for branch: $BRANCH"
          fi
